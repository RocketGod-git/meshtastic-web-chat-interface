<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat with Meshtastic Device</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>
<body data-connected="{{ connected }}">
    <div class="modal" tabindex="-1" role="dialog" id="portModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select COM Port</h5>
                </div>
                <div class="modal-body">
                    <label for="comPort">COM Port</label>
                    <select id="comPort" class="form-control">
                        {% for port in ports %}
                            <option value="{{ port }}">{{ port }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="connectToPort()">Connect</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-3" id="channelList">
                <h3>Channels</h3>
                <ul class="list-group" id="channels">
                    {% for channel in channels %}
                        <li class="list-group-item" onclick="selectChannel({{ channel.index }})">{{ channel.name }}</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-9">
                <h1>Meshtastic Chat Interface</h1>
                <div id="chatArea">
                    <label for="message">Message:</label>
                    <input type="text" id="message" class="form-control" placeholder="Enter message">
                    <button onclick="sendMessage()" class="btn btn-success">Send Message</button>
                    <h2>Messages</h2>
                    <div id="messagesWindow" class="form-control" style="height: 200px; overflow-y: scroll;"></div>
                </div>
                <h2>Serial Monitor</h2>
                <textarea id="serialMonitor" class="form-control" rows="10" readonly></textarea>
                <button onclick="clearSerialMonitor()" class="btn btn-secondary mt-2">Clear Serial Monitor</button>
            </div>
        </div>
    </div>

    <script>
        var currentChannel = null;

        $(document).ready(function() {
            var connected = $('body').data('connected') === 'True';
            if (!connected) {
                console.log("Opening port selection modal.");
                $('#portModal').modal('show');
            } else {
                console.log("Already connected to serial port.");
                startEventSource();
            }
        });

        function connectToPort() {
            var port = $('#comPort').val();
            console.log("Port selected: " + port);
            $.post('/connect', { port: port }, function(response) {
                if (response.status === 'connected') {
                    console.log('Connected to ' + response.port);
                    alert('Connected to ' + response.port);
                    $('#portModal').modal('hide');
                    startEventSource();
                } else {
                    console.error('Error: ' + response.message);
                    alert('Error: ' + response.message);
                }
            });
        }

        function startEventSource() {
            var source = new EventSource('/stream');
            source.onmessage = function(event) {
                var serialMonitor = document.getElementById('serialMonitor');
                serialMonitor.value += event.data + '\n';
                serialMonitor.scrollTop = serialMonitor.scrollHeight;
            };
            source.addEventListener('channel_info', function(event) {
                var channelData = JSON.parse(event.data);
                var channelList = document.getElementById('channels');
                var listItem = document.createElement('li');
                listItem.textContent = channelData.name;
                listItem.className = 'list-group-item';
                listItem.onclick = function() { selectChannel(channelData.index); };
                channelList.appendChild(listItem);
            });
            source.addEventListener('receive_message', function(event) {
                var messageData = JSON.parse(event.data);
                console.log('Message received on channel ' + messageData.channel + ': ' + messageData.message);
                if (messageData.channel === currentChannel) {
                    var messagesWindow = document.getElementById('messagesWindow');
                    messagesWindow.innerHTML += '<p>' + messageData.message + '</p>';
                    messagesWindow.scrollTop = messagesWindow.scrollHeight;
                }
            });
        }

        function sendMessage() {
            var message = $('#message').val();
            console.log("Sending message on channel " + currentChannel + ": " + message);
            if (currentChannel !== null && message.trim() !== '') {
                $.post('/send_message', { message: message, channel: currentChannel }, function(response) {
                    if (response.status === 'sent') {
                        $('#message').val('');
                    } else {
                        console.error('Error: ' + response.message);
                        alert('Error: ' + response.message);
                    }
                });
            } else {
                alert('No channel selected or message is empty!');
            }
        }

        function selectChannel(channel) {
            console.log("Channel selected: " + channel);
            currentChannel = channel;
            var messagesWindow = document.getElementById('messagesWindow');
            messagesWindow.innerHTML = '';
            alert('Channel ' + channel + ' selected');
        }

        function clearSerialMonitor() {
            var serialMonitor = document.getElementById('serialMonitor');
            serialMonitor.value = '';
        }

        $(window).on('beforeunload', function() {
            $.post('/disconnect');
        });
    </script>
</body>
</html>
