<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Meshtastic Web Interface</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <h1>Meshtastic Web Interface</h1>
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="portSelect">Select COM Port:</label>
                    <select class="form-control" id="portSelect">
                        {% for port in ports %}
                            <option value="{{ port }}">{{ port }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button class="btn btn-primary" id="connectBtn">Connect</button>
                <button class="btn btn-danger" id="disconnectBtn" disabled>Disconnect</button>
            </div>
            <div class="col-md-8">
                <div class="form-group">
                    <label for="messageInput">Message:</label>
                    <input type="text" class="form-control" id="messageInput" placeholder="Enter message">
                </div>
                <div class="form-group">
                    <label for="channelSelect">Select Channel:</label>
                    <select class="form-control" id="channelSelect"></select>
                </div>
                <button class="btn btn-success" id="sendBtn" disabled>Send Message</button>
            </div>
        </div>
        <hr>
        <h2>Received Messages</h2>
        <div id="messagesContainer"></div>
        <hr>
        <h2>Device Information</h2>
        <div id="deviceInfo"></div>
        <hr>
        <h2>Node Information</h2>
        <div id="nodeInfo"></div>
    </div>

    <script>
        $(document).ready(function() {
            var eventSource = null;
            var primaryChannel = null;

            $('#connectBtn').click(function() {
                var selectedPort = $('#portSelect').val();
                $.post('/connect', { port: selectedPort }, function(response) {
                    if (response.status === 'connected') {
                        $('#connectBtn').prop('disabled', true);
                        $('#disconnectBtn').prop('disabled', false);
                        $('#sendBtn').prop('disabled', false);
                        startEventSource();
                    } else {
                        alert('Failed to connect: ' + response.message);
                    }
                });
            });

            $('#disconnectBtn').click(function() {
                $.post('/disconnect', function(response) {
                    if (response.status === 'disconnected') {
                        $('#connectBtn').prop('disabled', false);
                        $('#disconnectBtn').prop('disabled', true);
                        $('#sendBtn').prop('disabled', true);
                        stopEventSource();
                    } else {
                        alert('Failed to disconnect: ' + response.message);
                    }
                });
            });

            $('#sendBtn').click(function() {
                var message = $('#messageInput').val();
                var channel = $('#channelSelect').val() || primaryChannel;
                $.post('/send_message', { message: message, channel: channel }, function(response) {
                    if (response.status === 'sent') {
                        $('#messageInput').val('');
                    } else {
                        alert('Failed to send message: ' + response.message);
                    }
                });
            });

            function startEventSource() {
                eventSource = new EventSource('/stream');

                eventSource.addEventListener('primary_channel', function(event) {
                    var channelData = JSON.parse(event.data);
                    primaryChannel = channelData.index;
                    var channelSelect = $('#channelSelect');
                    channelSelect.append($('<option>', {
                        value: channelData.index,
                        text: channelData.name + ' (Primary)'
                    }));
                });

                eventSource.addEventListener('channel_info', function(event) {
                    var channelData = JSON.parse(event.data);
                    var channelSelect = $('#channelSelect');
                    channelSelect.append($('<option>', {
                        value: channelData.index,
                        text: channelData.name
                    }));
                });

                eventSource.addEventListener('text_message', function(event) {
                    var messageData = JSON.parse(event.data);
                    var messagesContainer = $('#messagesContainer');
                    messagesContainer.append('<p><strong>From:</strong> ' + messageData.sender + '<br><strong>Message:</strong> ' + messageData.text + '</p><hr>');
                });

                eventSource.addEventListener('user_data', function(event) {
                    var userData = JSON.parse(event.data);
                    var deviceInfo = $('#deviceInfo');
                    deviceInfo.html('<p><strong>Device ID:</strong> ' + userData.id + '<br><strong>Long Name:</strong> ' + userData.longName + '<br><strong>Short Name:</strong> ' + userData.shortName + '<br><strong>MAC Address:</strong> ' + userData.macaddr + '<br><strong>Hardware Model:</strong> ' + userData.hwModel + '</p>');
                });

                eventSource.addEventListener('position_data', function(event) {
                    var positionData = JSON.parse(event.data);
                    var nodeInfo = $('#nodeInfo');
                    nodeInfo.html('<p><strong>Sender:</strong> ' + positionData.sender + '<br><strong>Latitude:</strong> ' + positionData.latitude + '<br><strong>Longitude:</strong> ' + positionData.longitude + '<br><strong>Altitude:</strong> ' + positionData.altitude + '</p>');
                });

                eventSource.addEventListener('telemetry_data', function(event) {
                    var telemetryData = JSON.parse(event.data);
                    var deviceInfo = $('#deviceInfo');
                    deviceInfo.append('<p><strong>Battery Level:</strong> ' + telemetryData.batteryLevel + '<br><strong>Voltage:</strong> ' + telemetryData.voltage + '<br><strong>Channel Utilization:</strong> ' + telemetryData.channelUtilization + '<br><strong>Air Utilization TX:</strong> ' + telemetryData.airUtilTx + '<br><strong>Uptime Seconds:</strong> ' + telemetryData.uptimeSeconds + '</p>');
                });
            }

            function stopEventSource() {
                if (eventSource !== null) {
                    eventSource.close();
                    eventSource = null;
                }
            }
        });
    </script>
</body>
</html>
